From c00639252121cde32e07c9fee4e0ab5c3aeed648 Mon Sep 17 00:00:00 2001
From: "Spencer E. Olson" <olsonse@umich.edu>
Date: Sat, 28 May 2022 15:21:19 -0600
Subject: [PATCH 2/8] Fix minimal command line argument parsing

This patch also ensures that all memory has been appropriately freed
(passes a valgrind/memgrind leak test).

Signed-off-by: Spencer E. Olson <olsonse@umich.edu>
---
 src/aklog-kafs.c | 31 +++++++++++++++++--------------
 1 file changed, 17 insertions(+), 14 deletions(-)

diff --git a/src/aklog-kafs.c b/src/aklog-kafs.c
index 16aa9a9..01e4763 100644
--- a/src/aklog-kafs.c
+++ b/src/aklog-kafs.c
@@ -1,4 +1,5 @@
 /* aklog.c: description
+ * vim: noet:ts=2:sw=2:tw=80:nowrap
  *
  * Copyright (C) 2017 Red Hat, Inc. All Rights Reserved.
  * Written by David Howells (dhowells@redhat.com)
@@ -32,7 +33,6 @@
 #include <sys/socket.h>
 #include <krb5/krb5.h>
 #include <linux/if_alg.h>
-#include <unistd.h>
 
 // command line switches
 bool opt_debug   = false;
@@ -353,6 +353,7 @@ int main(int argc, char **argv)
 {
 	int opt;
 
+	char *cell_scratch;
 	char *cell, *realm, *princ, *desc, *p;
 	int ret;
 	size_t plen;
@@ -367,38 +368,33 @@ int main(int argc, char **argv)
 		case 'd':
 			opt_debug = true;
 			opt_verbose = true;
-      --argc;
 			break;
-		//default:
+		default:
 		case 'h':
 			display_usage();
 			break;
 		case 'v':
 			opt_verbose = true;
-      --argc;
 			break;
 		}
 	}
 
-	if (opt_debug) {
-		printf("argc: %d\n", argc);
-		printf("optind: %d\n", optind);
-	}
-	if (argc > 3) {
-		fprintf(stderr, "ERROR: too many arguments\n");
+	if ((argc - optind) > 2) {
+		fprintf(stderr, "ERROR: unexpected arguments after options\n");
 		display_usage();
 	}
 
-	if (argc == 1) {
-		cell = get_default_cell();
-		if (opt_debug) {
+	if ((argc - optind) <= 0) {
+		cell = cell_scratch = get_default_cell();
+		if (opt_verbose) {
 			printf("Cell from /proc/net/afs/rootcell: %s\n", cell);
 		}
 	} else {
+		cell_scratch = NULL;
 		cell = argv[optind];
 	}
 
-	if (argc == 2) {
+	if ((argc - optind) > 1) {
 		realm = strdup(argv[optind + 1]);
 		OSZERROR(realm, "strdup");
 	} else {
@@ -471,6 +467,13 @@ int main(int argc, char **argv)
 	ret = add_key("rxrpc", desc, payload, plen, KEY_SPEC_SESSION_KEYRING);
 	OSERROR(ret, "add_key");
 
+	if (cell_scratch) {
+		free(cell_scratch);
+	}
+	free(realm);
+	free(princ);
+	free(desc);
+	free(payload);
 	krb5_free_creds(k5_ctx, creds);
 	krb5_free_cred_contents(k5_ctx, &search_cred);
 	krb5_cc_close(k5_ctx, cc);
-- 
2.30.2

